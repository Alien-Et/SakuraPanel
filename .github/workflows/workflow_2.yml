name: Python for Android

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.13 and Dependencies
        run: |
          # 添加 deadsnakes PPA 并安装 Python 3.13
          sudo apt-get update -y
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y ppa:deadsnakes/ppa
          sudo apt-get update -y
          sudo apt-get install -y python3.13 python3.13-dev python3.13-venv

          # 创建虚拟环境（避免污染系统 Python）
          python3.13 -m venv /opt/python3.13
          source /opt/python3.13/bin/activate

          # 安装编译工具链
          sudo apt-get install -y build-essential zlib1g-dev libffi-dev libssl-dev \
                                  libbz2-dev libreadline-dev libsqlite3-dev wget curl \
                                  llvm libncurses5-dev libncursesw5-dev xz-utils tk-dev \
                                  libxml2-dev libxmlsec1-dev liblzma-dev git tar unzip binutils

          # 验证版本
          python3.13 --version
          pip3.13 --version || echo "Pip not found, will install later"

      - name: Set up Android NDK
        uses: android-actions/setup-android@v2
        with:
          ndk-version: "25.2.9519653"  # 固定 NDK 版本

      - name: Configure Android Toolchain
        run: |
          # 设置 NDK 环境变量
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
          echo "$ANDROID_NDK_ROOT" >> $GITHUB_PATH

          # 定义交叉编译工具链路径
          TOOLCHAIN="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin"
          export CC="$TOOLCHAIN/aarch64-linux-android21-clang"
          export CXX="$TOOLCHAIN/aarch64-linux-android21-clang++"
          export AR="$TOOLCHAIN/llvm-ar"
          export RANLIB="$TOOLCHAIN/llvm-ranlib"
          export READELF=$(which readelf)

          # 验证工具是否存在
          ls -l $CC $CXX $AR $RANLIB
          echo "CC=$CC" >> $GITHUB_ENV
          echo "CXX=$CXX" >> $GITHUB_ENV
          echo "AR=$AR" >> $GITHUB_ENV
          echo "RANLIB=$RANLIB" >> $GITHUB_ENV
          echo "READELF=$READELF" >> $GITHUB_ENV

      - name: Download Python 3.13 Source
        run: |
          wget https://www.python.org/ftp/python/3.13.0/Python-3.13.0.tar.xz
          tar -xf Python-3.13.0.tar.xz
          mv Python-3.13.0 cpython

      - name: Download zlib Source
        run: |
          wget https://github.com/madler/zlib/archive/refs/tags/v1.2.13.tar.gz -O zlib-1.2.13.tar.gz
          tar -xvf zlib-1.2.13.tar.gz

      - name: Configure and Compile Python
        run: |
          cd cpython
          # 禁用优化和 IPv6（减少依赖问题）
          cat <<EOF > config.site
          ac_cv_file__dev_ptmx=yes
          ac_cv_file__dev_ptc=no
          EOF

          ./configure --host=aarch64-linux-android \
                     --build=x86_64-linux-gnu \
                     --disable-ipv6 \
                     --disable-optimizations \
                     --with-build-python=$(which python3.13) \
                     CC="$CC" \
                     CXX="$CXX" \
                     AR="$AR" \
                     RANLIB="$RANLIB" \
                     READELF="$READELF"

          make -j$(nproc)

      - name: Compile zlib
        run: |
          cd zlib-1.2.13
          CC="$CC" ./configure --prefix=$GITHUB_WORKSPACE/android-rootfs/data
          make -j$(nproc)

      - name: Install Python and zlib
        run: |
          mkdir -p $GITHUB_WORKSPACE/android-rootfs/data
          cd cpython
          make install prefix=$GITHUB_WORKSPACE/android-rootfs/data
          cd ../zlib-1.2.13
          make install

      - name: Package Artifacts
        run: |
          tar -czvf python-3.13-android-arm64.tar.gz -C android-rootfs/data .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-3.13-android-arm64
          path: python-3.13-android-arm64.tar.gz
